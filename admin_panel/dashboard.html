<!doctype html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω–∫–∞ Nat's Shop</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
    }

    .navbar {
      display: flex;
      background-color: #333;
      overflow: hidden;
    }

    .navbar a {
      flex: 1;
      color: white;
      padding: 14px;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
    }

    .navbar a:hover,
    .navbar a.active {
      background-color: #575757;
    }

    .logout {
      float: right;
      margin: 14px;
    }

    .tab-content {
      display: none;
      padding: 20px;
    }

    .tab-content.active {
      display: block;
    }

    h2 {
      margin-top: 0;
    }

    table {
      border-collapse: collapse;
      margin-top: 10px;
      width: auto;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background-color: #f7f7f7;
    }

    form.inline {
      display: inline;
    }

    input,
    select,
    button {
      margin: 5px 10px 5px 0;
    }

    #orderDetailsModal {
      display: none;
      position: fixed;
      top: 5%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 20px;
      border: 1px solid #ccc;
      z-index: 1001;
      width: 80%;
      /* —à–∏—Ä–µ */
      max-height: 90%;
      /* –æ–≥—Ä–∞–Ω–∏—á–∏–º –≤—ã—Å–æ—Ç—É */
      overflow-y: auto;
      /* –¥–æ–±–∞–≤–∏–º —Å–∫—Ä–æ–ª–ª, –µ—Å–ª–∏ –º–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤ */
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }

    #orderDetailsContent {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: flex-start;
    }

    #orderDetailsContent .order-item {
      width: 200px;
      text-align: center;
      margin-bottom: 20px;
    }

    #orderDetailsContent .order-item img {
      width: 100%;
      max-height: 200px;
      object-fit: contain;
    }
  </style>
</head>

<body>

  <div class="navbar">
    <a class="tab-link active" onclick="showTab(event, 'products')">–¢–æ–≤–∞—Ä—ã</a>
    <a class="tab-link" onclick="showTab(event, 'orders')">–ó–∞–∫–∞–∑—ã</a>
    <a class="tab-link" onclick="showTab(event, 'analytics')">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
    <a href="{{ url_for('logout') }}" class="logout">–í—ã—Ö–æ–¥</a>
  </div>

  <!-- –¢–æ–≤–∞—Ä—ã -->
  <div id="products" class="tab-content">
    <h2>–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</h2>
    <button onclick="openAddModal()">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
    <table>
      <thead>
        <tr>
          <th>‚Ññ</th>
          <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
          <th>–¶–µ–Ω–∞</th>
          <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
          <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
        </tr>
      </thead>
      <tbody>
        {% for key, p in products.items() %} {% if p %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ p.name }}</td>
          <td>{{ p.price }}‚ÇΩ</td>
          <td>
            {% if p.imageUrl %}
            <img src="{{ p.imageUrl }}" alt="image" width="100" height="100" style="object-fit: cover;"> {% endif %}
          </td>
          <td>
            <button onclick="openEditModal('{{ key }}', '{{ p.name }}', '{{ p.price }}', '{{ p.imageUrl }}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          </td>
        </tr>
        {% endif %} {% endfor %}
      </tbody>
    </table>
  </div>

  <div id="addModal" style="display:none; position:fixed; top:20%; left:50%; transform:translate(-50%, -20%); background:white; padding:20px; border:1px solid #ccc; z-index:1000;">
    <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
    <form id="addForm" method="post" enctype="multipart/form-data" action="{{ url_for('add_product') }}">
      <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
      <br>
      <input type="text" name="price" placeholder="–¶–µ–Ω–∞" required>
      <br>
      <input type="file" name="image" required>
      <br>
      <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button type="button" onclick="closeAddModal()">–û—Ç–º–µ–Ω–∞</button>
    </form>
  </div>

  <div id="editModal" style="display:none; position:fixed; top:20%; left:50%; transform:translate(-50%, -20%); background:white; padding:20px; border:1px solid #ccc; z-index:1000;">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h3>
    <form id="editForm" method="post" enctype="multipart/form-data">
      <input type="text" name="name" id="editName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
      <br>
      <input type="text" name="price" id="editPrice" placeholder="–¶–µ–Ω–∞">
      <br>
      <input type="file" name="image">
      <br>
      <img id="currentImage" src="" width="100">
      <br>
      <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
    </form>
    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
    <form id="deleteForm" action="" method="post" style="display:inline-block;">
      <button type="submit" style="background:red; color:white;">–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
    </form>
  </div>
  <div id="modalOverlay" onclick="closeEditModal()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; opacity:0.5; z-index:999;"></div>

  <!-- –ó–∞–∫–∞–∑—ã -->
  <div id="orders" class="tab-content">
    <h2>–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤</h2>

    <table>
      <thead>
        <tr>
          <th>ID –∑–∞–∫–∞–∑–∞</th>
          <th>–°—É–º–º–∞</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
          <th>–î–µ—Ç–∞–ª–∏</th>
          <th>–û–±–Ω–æ–≤–∏—Ç—å</th>
        </tr>
      </thead>
      <tbody>
        {% for key, o in orders.items() %}
        <form method="post" action="{{ url_for('update_status', order_id=key) }}">
          <tr>
            <td>{{ key }}</td>
            <td>{{ o.totalAmount }}‚ÇΩ</td>
            <td>
              <select name="status">
                <option value="–æ—Ñ–æ—Ä–º–ª–µ–Ω" {% if o.status=='–¥–æ—Å—Ç–∞–≤–ª–µ–Ω' %}selected{% endif %}>–û—Ñ–æ—Ä–º–ª–µ–Ω</option>
                <option value="–æ–ø–ª–∞—á–µ–Ω–æ" {% if o.status=='–æ–ø–ª–∞—á–µ–Ω–æ' %}selected{% endif %}>–û–ø–ª–∞—á–µ–Ω–æ</option>
                <option value="–≤ —Ä–∞–±–æ—Ç–µ" {% if o.status=='–≤ —Ä–∞–±–æ—Ç–µ' %}selected{% endif %}>–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="–≤ –¥–æ—Å—Ç–∞–≤–∫–µ" {% if o.status=='–≤ –¥–æ—Å—Ç–∞–≤–∫–µ' %}selected{% endif %}>–í –¥–æ—Å—Ç–∞–≤–∫–µ</option>
                <option value="–¥–æ—Å—Ç–∞–≤–ª–µ–Ω" {% if o.status=='–¥–æ—Å—Ç–∞–≤–ª–µ–Ω' %}selected{% endif %}>–î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
                <option value="–∑–∞–∫—Ä—ã—Ç" {% if o.status=='–∑–∞–∫—Ä—ã—Ç' %}selected{% endif %}>–ó–∞–∫—Ä—ã—Ç</option>
              </select>

            </td>
            <td>
              <button type="button" class="order-details-btn" data-products='{{ o.productList | tojson | safe }}' data-name="{{ users[o.userId].name if users[o.userId] else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}" data-phone="{{ users[o.userId].phone if users[o.userId] else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}" data-telegram="{{ users[o.userId].telegram if users[o.userId] else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}" data-address="{{ users[o.userId].address if users[o.userId] else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}" data-timestamp="{{ o.timestamp | datetime if o.timestamp else '–ù–µ —É–∫–∞–∑–∞–Ω–æ'  }}" data-closedat="{{ o.closedAt | datetime if o.closedAt else '–ù–µ –∑–∞–∫—Ä—ã—Ç' }}">
                –ü–æ–¥—Ä–æ–±–Ω–µ–µ
              </button>
            </td>
            <td>
              <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </td>
          </tr>
        </form>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div id="orderDetailsModal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:white; padding:20px; border:1px solid #ccc; z-index:1001; max-width:600px;">
    <h3>–î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞</h3>
    <div id="orderDetailsContent" style="display: flex; flex-wrap: wrap; gap: 15px;"></div>
    <button onclick="closeOrderDetailsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <div id="modalOverlayOrder" onclick="closeOrderDetailsModal()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; opacity:0.5; z-index:1000;"></div>
  </div>

  <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
  <div id="analytics" class="tab-content">
    <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–æ–≤–∞—Ä–∞–º</h2>
    <p>–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: {{ analytics.total_products }}</p>
    <p>–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: {{ analytics.average_price }} ‚ÇΩ</p>
    <p>–°–∞–º—ã–π –¥–æ—Ä–æ–≥–æ–π —Ç–æ–≤–∞—Ä: {{ analytics.most_expensive }}</p>
    <p>–°–∞–º—ã–π –¥–µ—à—ë–≤—ã–π —Ç–æ–≤–∞—Ä: {{ analytics.cheapest }}</p>
    {% if price_graph %}
    <div class="graph-section">

      {{ price_graph|safe }}
    </div>
    {% endif %} {% if status_graph %}
    <div class="graph-section">
      {{ status_graph|safe }}
    </div>
    {% endif %} {% if status_graph %}
    <div class="graph-section">
      {{ orders_graph | safe }}
    </div>
    {% endif %}

    <div>
      <h3>–°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂ –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
      <table border="1">
        <thead>
          <tr>
            <th>–ú–µ—Å—è—Ü</th>
            <th>–°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂</th>
          </tr>
        </thead>
        <tbody>
          {% for row in sales_data %}
          <tr>
            <td>{{ row['–ú–µ—Å—è—Ü'] }}</td>
            <td>{{ row['–°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂'] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    function showTab(evt, tabId) {
      const tabs = document.getElementsByClassName("tab-content");
      for (let tab of tabs) tab.classList.remove("active");
      const links = document.getElementsByClassName("tab-link");
      for (let link of links) link.classList.remove("active");
      document.getElementById(tabId).classList.add("active");
      evt.currentTarget.classList.add("active");
    }

    function openEditModal(productId, productName, productPrice, productImageUrl) {
      document.getElementById('editModal').style.display = 'block';
      document.getElementById('modalOverlay').style.display = 'block';
      document.getElementById('editName').value = productName;
      document.getElementById('editPrice').value = productPrice;
      document.getElementById('currentImage').src = productImageUrl;
      var editForm = document.getElementById('editForm');
      editForm.action = "/update_product/" + productId;
      var deleteForm = document.getElementById('deleteForm');
      deleteForm.action = "/delete_product/" + productId;
    }
    document.querySelectorAll(".order-details-btn").forEach(button => {
      button.addEventListener("click", () => {
        const productList = JSON.parse(button.dataset.products || "[]");
        const clientName = button.dataset.name || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
        const clientPhone = button.dataset.phone || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
        const clientTelegram = button.dataset.telegram || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
        const clientAddress = button.dataset.address || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
        const timestamp = button.dataset.timestamp || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
        const closedAt = button.dataset.closedat || "–ù–µ –∑–∞–∫—Ä—ã—Ç";
        const content = document.getElementById("orderDetailsContent");
        content.innerHTML = "";
        const wrapper = document.createElement("div");
        wrapper.style.width = "100%";
        const clientInfo = document.createElement("div");
        clientInfo.innerHTML = `
            <p><strong>–ò–º—è:</strong> ${clientName}</p>
            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${clientPhone}</p>
            <p><strong>Telegram:</strong> ${clientTelegram}</p>
            <p><strong>–ê–¥—Ä–µ—Å:</strong> ${clientAddress}</p>
            <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> ${timestamp}</p>
            <p><strong>–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è:</strong> ${closedAt}</p>
            <hr>
        `;
        wrapper.appendChild(clientInfo);
        if (productList.length === 0) {
          const noProducts = document.createElement("p");
          noProducts.textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–≤–∞—Ä–∞—Ö.";
          wrapper.appendChild(noProducts);
        } else {
          const productContainer = document.createElement("div");
          productContainer.style.display = "flex";
          productContainer.style.flexWrap = "wrap";
          productContainer.style.gap = "15px";
          productList.forEach(product => {
            const item = document.createElement("div");
            item.style.border = "1px solid #ccc";
            item.style.padding = "10px";
            item.style.width = "200px";
            let productDetails = `
                    <img src="${product.imageUrl}" alt="${product.name}" style="width:100%; max-height:200px; object-fit:contain;"><br>
                    <strong>${product.name}</strong><br>
                    ${product.price}‚ÇΩ
                `;
            item.innerHTML = productDetails;
            productContainer.appendChild(item);
          });
          wrapper.appendChild(productContainer);
        }
        content.appendChild(wrapper);
        document.getElementById("orderDetailsModal").style.display = "block";
        document.getElementById("modalOverlayOrder").style.display = "block";
      });
    });

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      document.getElementById('modalOverlay').style.display = 'none';
    }

    function closeOrderDetailsModal() {
      document.getElementById("orderDetailsModal").style.display = "none";
      document.getElementById("modalOverlayOrder").style.display = "none";
    }

    function openAddModal() {
      document.getElementById("addModal").style.display = "block";
      document.getElementById("modalOverlay").style.display = "block";
    }

    function closeAddModal() {
      document.getElementById("addModal").style.display = "none";
      document.getElementById("modalOverlay").style.display = "none";
    }
    window.onload = function() {
      document.querySelector('.tab-link.active').click();
    };
  </script>

</body>

</html>
